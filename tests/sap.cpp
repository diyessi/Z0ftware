// MIT License
//
// Copyright (c) 2023 Scott Cyphers
//
// Permission is hereby granted, free of charge, to any person obtaining a copy
// of this software and associated documentation files (the "Software"), to deal
// in the Software without restriction, including without limitation the rights
// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell
// copies of the Software, and to permit persons to whom the Software is
// furnished to do so, subject to the following conditions:
//
// The above copyright notice and this permission notice shall be included in
// all copies or substantial portions of the Software.
//
// THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN THE
// SOFTWARE.

#include "Z0ftware/asm.hpp"
#include "Z0ftware/operation.hpp"

#include <gtest/gtest.h>

TEST(sap, REM) {
  SAPAssembler parser;

  std::string line("       REM  This is a comment");
  auto operation = parser.parseLine(line);
  ASSERT_TRUE(operation->on([](Rem &rem) {}));
  EXPECT_EQ(operation->getComment(), "This is a comment");
}

TEST(sap, BCD) {
  SAPAssembler sap;
  {
    std::string line("       BCD 1ABCDEF");
    auto operation = sap.parseLine(line);
    Bcd *bcd{nullptr};
    ASSERT_TRUE(operation->on([&bcd](Bcd &ref) { bcd = &ref; }));
    auto &values = bcd->getValues();
    ASSERT_EQ(values.size(), 1);
    EXPECT_EQ(values.at(0), FixPoint(false, 0212223242526));
  }
  {
    std::string line("       BCD  0123456789=\"");
    auto operation = sap.parseLine(line);
    Bcd *bcd{nullptr};
    ASSERT_TRUE(operation->on([&bcd](Bcd &ref) { bcd = &ref; }));
    auto &values = bcd->getValues();
    ASSERT_EQ(values.size(), 10);
    EXPECT_EQ(values.at(0), FixPoint(false, 0000102030405));
    EXPECT_EQ(values.at(1), FixPoint(false, 0060710111314));
  }
}

TEST(sap, parseOCT) {
  SAPAssembler sap;
  {
    std::string line("       OCT 1,23,-456,+700");
    auto operation = sap.parseLine(line);
    Oct *oct{nullptr};
    ASSERT_TRUE(operation->on([&oct](Oct &ref) { oct = &ref; }));
    const auto &values = oct->getValues();
    ASSERT_EQ(values.size(), 4);
    EXPECT_EQ(values.at(0), FixPoint(false, 01));
    EXPECT_EQ(values.at(1), FixPoint(false, 023));
    EXPECT_EQ(values.at(2), FixPoint(true, 0456));
    EXPECT_EQ(values.at(3), FixPoint(false, 0700));
  }
  {
    std::string line("       OCT 1,23 VALUES");
    auto operation = sap.parseLine(line);
    Oct *oct{nullptr};
    ASSERT_TRUE(operation->on([&oct](Oct &ref) { oct = &ref; }));
    const auto &values = oct->getValues();
    ASSERT_EQ(values.size(), 2);
    EXPECT_EQ(values.at(0), FixPoint(false, 01));
    EXPECT_EQ(values.at(1), FixPoint(false, 023));
    EXPECT_EQ(operation->getComment(), "VALUES");
  }
  {
    std::string line("       OCT --1,23 VALUES");
    auto operation = sap.parseLine(line);
    Oct *oct{nullptr};
    ASSERT_TRUE(operation->on([&oct](Oct &ref) { oct = &ref; }));
    ASSERT_TRUE(operation->hasErrors());
  }
  {
    std::string line("       OCT +-1,23 VALUES");
    auto operation = sap.parseLine(line);
    Oct *oct{nullptr};
    ASSERT_TRUE(operation->on([&oct](Oct &ref) { oct = &ref; }));
    ASSERT_TRUE(operation->hasErrors());
  }
}

TEST(sap, DEC) {
  SAPAssembler sap;
  std::string line("       DEC 210,2B2,1B2,146B8,.5B34,0.75E0,-0,-0.0 COMMENT");
  auto operation = sap.parseLine(line);
  Dec *dec{nullptr};
  ASSERT_TRUE(operation->on([&dec](Dec &ref) { dec = &ref; }));
  const auto &values = dec->getValues();
  ASSERT_EQ(values.size(), 8);
  EXPECT_EQ(values.at(0), FixPoint(false, 210));
  EXPECT_EQ(values.at(1), FixPoint(false, 0200000000000));
  EXPECT_EQ(values.at(2), FixPoint(false, 0100000000000));
  EXPECT_EQ(values.at(3), FixPoint(false, 0222000000000));
  EXPECT_EQ(values.at(4), FixPoint(false, 01));
  EXPECT_EQ(values.at(5), FixPoint(false, 0200600000000));
  EXPECT_EQ(values.at(6), FixPoint(true, 0));
  EXPECT_EQ(values.at(7), FixPoint(true, 0));
  EXPECT_EQ(operation->getComment(), "COMMENT");
}

TEST(sap, equ) {
  SAPAssembler sap;
  {
    auto operation = sap.parseLine(std::string("A      EQU 1"));
    ASSERT_TRUE(operation->on([](Equ &ref) {}));
  }
  {
    auto operation = sap.parseLine(std::string("       EQU 1"));
    operation->validate(sap);
    ASSERT_TRUE(operation->on([](Equ &ref) {}));
    ASSERT_TRUE(operation->hasErrors());
  }
}
